--================= MH PRISON LIFE V1.2 =================--
-- MOBILE ONLY
-- by: Miel

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Lighting = game:GetService("Lighting")
local StarterGui = game:GetService("StarterGui")

local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

--================= NOTIFY =================--

local function notify(txt)
	pcall(function()
		StarterGui:SetCore("SendNotification",{
			Title = "MH Prison Life v1.2",
			Text = txt,
			Duration = 3
		})
	end)
end

--================= GUI =================--

local Gui = Instance.new("ScreenGui")
Gui.Name = "MH_PrisonLife_V1"
Gui.IgnoreGuiInset = true
Gui.Parent = game.CoreGui

local Border = Instance.new("Frame", Gui)
Border.Size = UDim2.new(0,280,0,380)
Border.Position = UDim2.new(0.5,-140,0.5,-190)
Border.BackgroundColor3 = Color3.fromRGB(255,0,0)
Border.BorderSizePixel = 0
Border.Active = true
Instance.new("UICorner", Border).CornerRadius = UDim.new(0,14)

local Main = Instance.new("Frame", Border)
Main.Size = UDim2.new(1,-4,1,-4)
Main.Position = UDim2.new(0,2,0,2)
Main.BackgroundColor3 = Color3.fromRGB(18,18,18)
Main.BorderSizePixel = 0
Main.Active = true
Instance.new("UICorner", Main).CornerRadius = UDim.new(0,12)

-- RGB border
task.spawn(function()
	local h = 0
	while true do
		h = (h + 0.3) % 360
		Border.BackgroundColor3 = Color3.fromHSV(h/360,1,1)
		task.wait(0.03)
	end
end)

-- Drag mobile
local dragging, dragStart, startPos
Main.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.Touch then
		dragging = true
		dragStart = input.Position
		startPos = Border.Position
	end
end)

UserInputService.InputChanged:Connect(function(input)
	if dragging and input.UserInputType == Enum.UserInputType.Touch then
		local delta = input.Position - dragStart
		Border.Position = UDim2.new(
			startPos.X.Scale, startPos.X.Offset + delta.X,
			startPos.Y.Scale, startPos.Y.Offset + delta.Y
		)
	end
end)

UserInputService.InputEnded:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.Touch then
		dragging = false
	end
end)

-- Title
local Title = Instance.new("TextLabel", Main)
Title.Size = UDim2.new(1,0,0,40)
Title.BackgroundTransparency = 1
Title.Text = "MH Prison Life v1.2"
Title.TextColor3 = Color3.new(1,1,1)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 15

-- Minimize
local MinBtn = Instance.new("TextButton", Main)
MinBtn.Size = UDim2.new(0,40,0,30)
MinBtn.Position = UDim2.new(1,-45,0,5)
MinBtn.Text = "-"
MinBtn.Font = Enum.Font.GothamBold
MinBtn.TextSize = 18
MinBtn.BackgroundColor3 = Color3.fromRGB(35,35,35)
MinBtn.TextColor3 = Color3.new(1,1,1)
Instance.new("UICorner", MinBtn)

local Content = Instance.new("ScrollingFrame", Main)
Content.Position = UDim2.new(0,0,0,40)
Content.Size = UDim2.new(1,0,1,-40)
Content.ScrollBarImageTransparency = 1
Content.BackgroundTransparency = 1

local layout = Instance.new("UIListLayout", Content)
layout.Padding = UDim.new(0,10)
layout.HorizontalAlignment = Enum.HorizontalAlignment.Center
layout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
	Content.CanvasSize = UDim2.new(0,0,0,layout.AbsoluteContentSize.Y + 10)
end)

local minimized = false
MinBtn.MouseButton1Click:Connect(function()
	minimized = not minimized
	Content.Visible = not minimized
	Border.Size = minimized and UDim2.new(0,280,0,40) or UDim2.new(0,280,0,380)
end)

local function createButton(text)
	local btn = Instance.new("TextButton")
	btn.Size = UDim2.new(0.9,0,0,40)
	btn.BackgroundColor3 = Color3.fromRGB(40,40,40)
	btn.TextColor3 = Color3.new(1,1,1)
	btn.Font = Enum.Font.GothamBold
	btn.TextSize = 14
	btn.Text = text
	btn.Parent = Content
	Instance.new("UICorner", btn)
	return btn
end

--================= BUTTONS =================--

local FPSBtn = createButton("FPS BOOST: OFF")
local ESPBtn = createButton("ESP: OFF")
local AIMBtn = createButton("AIMBOT: OFF")
local FOVBtn = createButton("SHOW FOV: OFF")

local CriminalBtn = createButton("Aim Criminals: ON")
local InmateBtn = createButton("Aim Inmates: OFF")
local GuardBtn = createButton("Aim Guards: OFF")

--================= FPS BOOST =================--

local FPS_ON = false
FPSBtn.MouseButton1Click:Connect(function()
	if FPS_ON then return end
	FPS_ON = true
	FPSBtn.Text = "FPS BOOST: ON"

	for _,v in pairs(workspace:GetDescendants()) do
		if v:IsA("BasePart") then
			v.Material = Enum.Material.Plastic
			v.Reflectance = 0
		elseif v:IsA("Decal") or v:IsA("Texture") then
			v:Destroy()
		elseif v:IsA("ParticleEmitter") or v:IsA("Trail") then
			v.Enabled = false
		end
	end
	Lighting.GlobalShadows = false
	notify("FPS Boost ativo! Bom jogo!")
end)

--================= ESP V2 =================--

local ESP_ON = false
local ESPFolder = Instance.new("Folder", Gui)
ESPFolder.Name = "ESP_V2"

-- cores por time
local function getTeamColor(plr)
	if not plr.Team then
		return Color3.fromRGB(255,255,255)
	end

	if plr.Team.Name == "Criminals" then
		return Color3.fromRGB(255,60,60)
	elseif plr.Team.Name == "Guards" then
		return Color3.fromRGB(0,170,255)
	elseif plr.Team.Name == "Inmates" then
		return Color3.fromRGB(255,170,0)
	end

	return Color3.fromRGB(255,255,255)
end

-- remove ESP do player
local function clearESP(plr)
	local esp = ESPFolder:FindFirstChild(plr.Name)
	if esp then
		esp:Destroy()
	end
end

-- aplica ESP
local function applyESP(plr)
	if not ESP_ON or plr == LocalPlayer then return end
	if not plr.Character then return end

	local char = plr.Character
	local hrp = char:FindFirstChild("HumanoidRootPart")
	local head = char:FindFirstChild("Head")
	local hum = char:FindFirstChild("Humanoid")

	if not hrp or not head or not hum or hum.Health <= 0 then return end

	clearESP(plr)

	local folder = Instance.new("Folder")
	folder.Name = plr.Name
	folder.Parent = ESPFolder

	-- Highlight
	local hl = Instance.new("Highlight")
	hl.Adornee = char
	hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
	hl.OutlineTransparency = 1
	hl.FillColor = getTeamColor(plr)
	hl.Parent = folder

	-- BillboardGui
	local bill = Instance.new("BillboardGui")
	bill.Adornee = head
	bill.Size = UDim2.new(0,140,0,45)
	bill.StudsOffset = Vector3.new(0,2.5,0)
	bill.AlwaysOnTop = true
	bill.Parent = folder

	local nameLabel = Instance.new("TextLabel", bill)
	nameLabel.Size = UDim2.new(1,0,0.5,0)
	nameLabel.BackgroundTransparency = 1
	nameLabel.Text = plr.Name
	nameLabel.Font = Enum.Font.GothamBold
	nameLabel.TextSize = 14
	nameLabel.TextColor3 = getTeamColor(plr)
	nameLabel.TextStrokeTransparency = 0.4

	local distLabel = Instance.new("TextLabel", bill)
	distLabel.Position = UDim2.new(0,0,0.5,0)
	distLabel.Size = UDim2.new(1,0,0.5,0)
	distLabel.BackgroundTransparency = 1
	distLabel.Font = Enum.Font.Gotham
	distLabel.TextSize = 13
	distLabel.TextColor3 = Color3.new(1,1,1)
	distLabel.TextStrokeTransparency = 0.4

	-- atualização
	local conn
	conn = RunService.RenderStepped:Connect(function()
		if not ESP_ON or not char.Parent or hum.Health <= 0 then
			if conn then conn:Disconnect() end
			clearESP(plr)
			return
		end

		local dist = math.floor((Camera.CFrame.Position - hrp.Position).Magnitude)
		distLabel.Text = dist .. " studs"

		local col = getTeamColor(plr)
		hl.FillColor = col
		nameLabel.TextColor3 = col
	end)
end

-- refresh geral
local function refreshESP()
	ESPFolder:ClearAllChildren()
	if not ESP_ON then return end

	for _,plr in pairs(Players:GetPlayers()) do
		applyESP(plr)

		-- respawn
		plr.CharacterAdded:Connect(function()
			task.wait(0.3)
			applyESP(plr)
		end)

		-- troca de time
		plr:GetPropertyChangedSignal("Team"):Connect(function()
			task.wait(0.1)
			applyESP(plr)
		end)
	end
end

-- botão ESP
ESPBtn.MouseButton1Click:Connect(function()
	ESP_ON = not ESP_ON
	ESPBtn.Text = "ESP: "..(ESP_ON and "ON" or "OFF")

	if ESP_ON then
		refreshESP()
	else
		ESPFolder:ClearAllChildren()
	end
end)

-- player entrou
Players.PlayerAdded:Connect(function(plr)
	if ESP_ON then
		task.wait(0.5)
		applyESP(plr)
	end
end)

-- player saiu
Players.PlayerRemoving:Connect(function(plr)
	clearESP(plr)
end)

--================= AIMBOT V2 + FOV =================--

local AIM_ON = false
local AIM_DISTANCE = 450
local FOV_RADIUS = 150

local AIM_CRIMINALS = true
local AIM_INMATES = false
local AIM_GUARDS = false

-- Lock system
local LockedTarget = nil
local lastValid = 0
local LOCK_TIMEOUT = 0.25

--================= FOV VISUAL =================--

local FOV_VISIBLE = false
local FOVCircle = Instance.new("Frame", Gui)
FOVCircle.AnchorPoint = Vector2.new(0.5,0.5)
FOVCircle.Position = UDim2.new(0.5,0,0.5,0)
FOVCircle.Size = UDim2.new(0,FOV_RADIUS*2,0,FOV_RADIUS*2)
FOVCircle.BackgroundTransparency = 1
FOVCircle.Visible = false
FOVCircle.ZIndex = 999

local stroke = Instance.new("UIStroke", FOVCircle)
stroke.Thickness = 2
stroke.Color = Color3.fromRGB(255,255,255)

Instance.new("UICorner", FOVCircle).CornerRadius = UDim.new(1,0)

FOVBtn.MouseButton1Click:Connect(function()
	FOV_VISIBLE = not FOV_VISIBLE
	FOVCircle.Visible = FOV_VISIBLE
	FOVBtn.Text = "SHOW FOV: "..(FOV_VISIBLE and "ON" or "OFF")
	notify(FOV_VISIBLE and "FOV ligado" or "FOV desligado")
end)

--================= FUNÇÕES =================--

local function inFOV(worldPos)
	local screenPos, onScreen = Camera:WorldToViewportPoint(worldPos)
	if not onScreen then return false end
	local center = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
	return (Vector2.new(screenPos.X, screenPos.Y) - center).Magnitude <= FOV_RADIUS
end

local function validTarget(plr)
	if not plr.Team then return false end
	if plr.Team.Name == "Criminals" and AIM_CRIMINALS then return true end
	if plr.Team.Name == "Inmates" and AIM_INMATES then return true end
	if plr.Team.Name == "Guards" and AIM_GUARDS then return true end
	return false
end

-- Raycast REAL (parede bloqueia)
local function hasLineOfSight(char)
	local head = char:FindFirstChild("Head")
	if not head then return false end

	local params = RaycastParams.new()
	params.FilterType = Enum.RaycastFilterType.Blacklist
	params.FilterDescendantsInstances = {LocalPlayer.Character}

	local ray = workspace:Raycast(
		Camera.CFrame.Position,
		head.Position - Camera.CFrame.Position,
		params
	)

	return ray and ray.Instance:IsDescendantOf(char)
end

local function isValid(plr)
	return plr
	and plr.Character
	and plr.Character:FindFirstChild("Head")
	and plr.Character:FindFirstChild("Humanoid")
	and plr.Character.Humanoid.Health > 0
	and validTarget(plr)
	and inFOV(plr.Character.Head.Position)
	and hasLineOfSight(plr.Character)
end

--================= TARGET SYSTEM =================--

local function getTarget()
	-- mantém lock se ainda válido
	if LockedTarget and isValid(LockedTarget) then
		lastValid = tick()
		return LockedTarget
	end

	-- pequeno delay antes de trocar
	if tick() - lastValid < LOCK_TIMEOUT then
		return LockedTarget
	end

	local closest, dist = nil, math.huge
	for _,p in pairs(Players:GetPlayers()) do
		if p ~= LocalPlayer and isValid(p) then
			local d = (p.Character.Head.Position - Camera.CFrame.Position).Magnitude
			if d < AIM_DISTANCE and d < dist then
				dist = d
				closest = p
			end
		end
	end

	LockedTarget = closest
	if closest then lastValid = tick() end
	return closest
end

--================= BOTÕES =================--

AIMBtn.MouseButton1Click:Connect(function()
	AIM_ON = not AIM_ON
	AIMBtn.Text = "AIMBOT: "..(AIM_ON and "ON" or "OFF")
	notify(AIM_ON and "Aimbot ativado!" or "Aimbot desativado")
end)

CriminalBtn.MouseButton1Click:Connect(function()
	AIM_CRIMINALS = not AIM_CRIMINALS
	CriminalBtn.Text = "Aim Criminals: "..(AIM_CRIMINALS and "ON" or "OFF")
end)

InmateBtn.MouseButton1Click:Connect(function()
	AIM_INMATES = not AIM_INMATES
	InmateBtn.Text = "Aim Inmates: "..(AIM_INMATES and "ON" or "OFF")
end)

GuardBtn.MouseButton1Click:Connect(function()
	AIM_GUARDS = not AIM_GUARDS
	GuardBtn.Text = "Aim Guards: "..(AIM_GUARDS and "ON" or "OFF")
end)

--================= LOOP =================--

RunService.RenderStepped:Connect(function()
	FOVCircle.Size = UDim2.new(0, FOV_RADIUS*2, 0, FOV_RADIUS*2)
	FOVCircle.Position = UDim2.new(0.5,0,0.5,0)

	if AIM_ON then
		local t = getTarget()
		if t and t.Character and t.Character:FindFirstChild("Head") then
			local camPos = Camera.CFrame.Position
			local headPos = t.Character.Head.Position
			local dist = (headPos - camPos).Magnitude

			-- smooth dinâmico (mobile friendly)
			local smooth = math.clamp(0.08 + (dist / AIM_DISTANCE) * 0.12, 0.08, 0.2)

			Camera.CFrame = Camera.CFrame:Lerp(
				CFrame.new(camPos, headPos),
				smooth
			)
		end
	else
		LockedTarget = nil
	end
end)

--================= LOAD =================--

notify("Carregado com sucesso!\nby: Miel")
