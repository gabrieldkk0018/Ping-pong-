local RunService = game:GetService("RunService")

local currentClone
local welds = {}

local function ClearClone()
	if currentClone then
		currentClone:Destroy()
		currentClone = nil
	end
	for _, w in ipairs(welds) do
		w:Destroy()
	end
	welds = {}

	local char = player.Character
	if char then
		for _, v in ipairs(char:GetDescendants()) do
			if v:IsA("BasePart") then
				v.LocalTransparencyModifier = 0
			end
		end
	end
end

local function StealCharacter(username)
	Status.Text = "Copying skin..."

	ClearClone()

	local success, userId = pcall(function()
		return Players:GetUserIdFromNameAsync(username)
	end)
	if not success then
		Status.Text = "Invalid username"
		return
	end

	local success2, model = pcall(function()
		return Players:CreateHumanoidModelFromUserId(userId)
	end)
	if not success2 or not model then
		Status.Text = "Failed to load avatar"
		return
	end

	model.Name = "MH_StolenCharacter"
	model.Parent = workspace
	currentClone = model

	-- REMOVE HUMANOID DO CLONE
	local cloneHumanoid = model:FindFirstChildOfClass("Humanoid")
	if cloneHumanoid then
		cloneHumanoid:Destroy()
	end

	local char = player.Character or player.CharacterAdded:Wait()

	-- ESCONDE SEU CORPO
	for _, v in ipairs(char:GetDescendants()) do
		if v:IsA("BasePart") then
			v.LocalTransparencyModifier = 1
		end
	end

	-- SOLDA PEÇA POR PEÇA
	for _, part in ipairs(model:GetDescendants()) do
		if part:IsA("BasePart") then
			part.Anchored = false
			part.CanCollide = false

			local original = char:FindFirstChild(part.Name)
			if original and original:IsA("BasePart") then
				part.CFrame = original.CFrame

				local weld = Instance.new("WeldConstraint")
				weld.Part0 = part
				weld.Part1 = original
				weld.Parent = part
				table.insert(welds, weld)
			end
		end
	end

	Status.Text = "Skin copied successfully"
end
